# iOS Scriptable Widget 使用指南

这是一个专为 iOS Scriptable 应用设计的流量监控 Widget，可以在 iPhone 主屏幕上以 4x4 小尺寸显示服务器流量统计。

## 功能特点

- 📱 **完美适配 4x4 Widget**：专为小尺寸设计，信息清晰易读
- 🎨 **自动主题切换**：支持深色/浅色模式自动适配
- 📊 **多维度数据展示**：今日、本月流量和月度使用进度
- 📈 **可视化进度条**：使用方块图标显示月度流量使用情况，支持半格填充
- 🔄 **自动刷新**：可配置刷新间隔（默认 5 分钟）
- ⚡ **快速响应**：10 秒超时，确保快速加载

## 安装步骤

### 1. 安装 Scriptable

从 App Store 下载并安装 [Scriptable](https://apps.apple.com/app/scriptable/id1405459188)

### 2. 导入脚本

1. 打开 Scriptable 应用
2. 点击右上角的 `+` 按钮创建新脚本
3. 将 `vnstat-widget.js` 文件的内容复制粘贴到编辑器中
4. 点击左上角的脚本名称，重命名为 "流量监控" 或你喜欢的名称

### 3. 配置服务器信息

在脚本的配置区域（文件开头）修改以下参数：

```javascript
const CONFIG = {
  // 修改为你的服务器地址
  SERVER_URL: 'http://your-server-ip:8080',
  
  // 如果服务器启用了 Token 鉴权，填写你的 Token
  TOKEN: 'your-secret-token',
  
  // 刷新间隔（秒），默认 300 秒（5分钟）
  REFRESH_INTERVAL: 300,
  
  // 可选：指定要显示的网络接口名称（留空则显示第一个）
  INTERFACE_NAME: '',
  
  // Widget 标题（自定义显示名称）
  WIDGET_TITLE: '流量监控',
  
  // 每月流量限制（GB），用于计算进度条
  MONTHLY_LIMIT_GB: 1000,
  
  // 进度条配置
  BOX_COUNT: 10,      // 进度条方块数量
  IS_SQUARE: true     // true = 正方形, false = 矩形
};
```

**重要提示**：
- 如果服务器在公网，使用 `http://` 或 `https://` 协议
- 如果服务器在局域网，确保手机和服务器在同一网络
- 如果服务器启用了 Token 鉴权，必须填写正确的 TOKEN
- `MONTHLY_LIMIT_GB` 用于计算月度流量使用百分比，请根据实际情况设置

### 4. 测试脚本

1. 在 Scriptable 中点击脚本运行按钮（▶️）
2. 查看是否正常显示数据
3. 如果出现错误，检查：
   - 服务器地址是否正确
   - Token 是否正确（如果启用）
   - 服务器是否可访问
   - 防火墙是否允许访问

### 5. 添加到主屏幕

1. 长按 iPhone 主屏幕进入编辑模式
2. 点击左上角的 `+` 按钮
3. 搜索并选择 "Scriptable"
4. 选择 "Small" (4x4) 尺寸
5. 点击 "Add Widget"
6. 长按新添加的 Widget，选择 "Edit Widget"
7. 在 "Script" 下拉菜单中选择你创建的脚本
8. 点击完成

## Widget 显示内容

Widget 会显示以下信息：

1. **标题栏**
   - 左侧：自定义标题（可在配置中修改 `WIDGET_TITLE`）
   - 右侧：刷新时间（时钟图标 + 时间）

2. **今日流量（Today）**
   - 图标：日历图标
   - 显示：今日总流量（上传 + 下载）

3. **本月流量（Month）**
   - 图标：带时钟的日历图标
   - 显示：本月总流量（上传 + 下载）

4. **月度使用进度（Month Used）**
   - 图标：仪表盘图标
   - 显示：已使用流量 / 月度限制（GB）
   - 百分比：使用率百分比（右侧显示）

5. **进度条**
   - 使用方块图标可视化显示月度流量使用情况
   - 支持半格填充，精确显示使用进度
   - 所有方块使用橙色，已填充为实心，未填充为空心

## 颜色说明

- 🟠 **橙色**：所有图标、进度条、强调元素
- ⚪ **灰色**：标签、次要信息、时间
- ⚫ **黑色/白色**：主要文本（根据系统主题自动切换）

## 自定义配置

### 修改 Widget 标题

```javascript
WIDGET_TITLE: '流量监控',  // 自定义标题文本
```

### 设置月度流量限制

用于计算进度条百分比，请根据你的实际套餐设置：

```javascript
MONTHLY_LIMIT_GB: 1000,  // 单位：GB
```

### 修改刷新间隔

```javascript
REFRESH_INTERVAL: 300,  // 单位：秒（300 = 5分钟）
```

### 指定网络接口

如果服务器有多个网络接口，可以指定要显示的接口：

```javascript
INTERFACE_NAME: 'eth0',  // 指定接口名称，留空则显示第一个
```

### 自定义进度条

```javascript
BOX_COUNT: 10,      // 进度条方块数量（建议 8-12）
IS_SQUARE: true     // true = 正方形, false = 矩形
```

**注意**：Widget 会自动适配系统的深色/浅色模式，无需手动配置颜色。

## 故障排除

### 问题：Widget 显示 "连接失败"

**可能原因和解决方法**：

1. **服务器地址错误**
   - 检查 `SERVER_URL` 是否正确
   - 确保包含端口号（如 `:8080`）

2. **网络不可达**
   - 如果服务器在局域网，确保手机和服务器在同一网络
   - 如果服务器在公网，确保防火墙允许访问

3. **Token 错误**
   - 如果服务器启用了鉴权，检查 TOKEN 是否正确
   - 确保 Token 与服务器配置一致

4. **服务器未运行**
   - 检查服务器上的 vnstat-http-server 是否正在运行
   - 可以先用浏览器访问 `/health` 接口测试

### 问题：数据不更新

- Widget 默认每 5 分钟自动刷新
- 可以手动长按 Widget 选择 "Run Script" 强制刷新
- 检查 `REFRESH_INTERVAL` 配置是否正确

### 问题：显示格式异常

- 确保使用 "Small" (4x4) 尺寸
- Widget 使用统一的圆角粗体字体，确保界面整齐
- 如果文本被截断，检查服务器地址和配置是否正确

### 问题：Today 数据显示为 0

- 确保服务器上的 vnstat 正在运行并收集数据
- 检查服务器时区设置是否正确
- Today 数据来自 `traffic.day` 数组的最后一个元素（id 最大的）

### 问题：进度条显示不正确

- 检查 `MONTHLY_LIMIT_GB` 配置是否正确
- 确保数值单位为 GB
- 进度条支持半格填充，不满一格时会显示半格图标

## 高级用法

### 使用 HTTPS

如果服务器配置了 HTTPS，修改 `SERVER_URL`：

```javascript
SERVER_URL: 'https://your-domain.com:8080',
```

### 多个服务器监控

可以创建多个脚本，每个脚本监控不同的服务器，然后创建多个 Widget 分别显示。

### 自定义显示内容

可以修改 `createWidget()` 函数来自定义显示的内容和布局。

## 技术支持

如果遇到问题，请检查：

1. Scriptable 应用是否是最新版本
2. 服务器 API 是否正常（用浏览器访问测试）
3. 脚本配置是否正确
4. 网络连接是否正常

更多信息请参考项目 README.md 文件。

